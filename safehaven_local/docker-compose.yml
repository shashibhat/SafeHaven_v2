services:
  frigate:
    image: ${FRIGATE_IMAGE:-ghcr.io/blakeblackshear/frigate:stable}
    container_name: safehaven-local-frigate
    profiles: ["frigate"]
    restart: unless-stopped
    shm_size: "256mb"
    ports:
      - "5000:5000"
      - "8971:8971"
    volumes:
      - ./frigate/config:/config
      - frigate-media:/media/frigate
    environment:
      FRIGATE_RTSP_PASSWORD: "safehaven"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  mock-frigate:
    image: ${PYTHON_BASE_IMAGE:-python:3.11-slim}
    container_name: safehaven-local-mock-frigate
    restart: unless-stopped
    command: ["python", "/app/mock_frigate_server.py"]
    volumes:
      - ./safehaven-core/scripts/mock_frigate_server.py:/app/mock_frigate_server.py:ro
    ports:
      - "5001:5001"
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:5001/healthz', timeout=2)"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 5s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  mosquitto:
    image: ${MOSQUITTO_IMAGE:-eclipse-mosquitto:2}
    container_name: safehaven-local-mosquitto
    restart: unless-stopped
    ports:
      - "1883:1883"
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  metis-detector:
    build:
      context: ./metis-detector
    container_name: safehaven-local-metis-detector
    restart: unless-stopped
    environment:
      - MOCK=${MOCK:-1}
      - MODEL_TASK=${MODEL_TASK:-detect}
      - MODEL_DIR=${MODEL_DIR:-/models/metis_yolo}
      - HOME=/tmp
      - MPLCONFIGDIR=/tmp/matplotlib
      - YOLO_CONFIG_DIR=/tmp/ultralytics
      - LOG_FORMAT=${LOG_FORMAT:-json}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ${MODEL_HOST_DIR:-./models}:/models:ro
    ports:
      - "8090:8090"
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8090/readyz', timeout=2)"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 20s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  safehaven-core:
    build:
      context: ./safehaven-core
    container_name: safehaven-local-core
    restart: unless-stopped
    depends_on:
      metis-detector:
        condition: service_healthy
      mock-frigate:
        condition: service_healthy
    environment:
      - FRIGATE_BASE_URL=${FRIGATE_BASE_URL:-http://mock-frigate:5001}
      - METIS_DETECTOR_URL=${METIS_DETECTOR_URL:-http://metis-detector:8090/detect}
      - SAFEHAVEN_CONFIG=${SAFEHAVEN_CONFIG:-/config/safehaven.yml}
      - SAMPLE_FPS=${SAMPLE_FPS:-1}
      - LEFT_OPEN_MINUTES=${LEFT_OPEN_MINUTES:-3}
      - QUEUE_MAX=${QUEUE_MAX:-50}
      - METRICS_PORT=${METRICS_PORT:-9108}
      - HEALTH_PORT=${HEALTH_PORT:-9109}
      - MQTT_BROKER=${MQTT_BROKER:-mosquitto}
      - LOG_FORMAT=${LOG_FORMAT:-json}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - METIS_TIMEOUT_S=${METIS_TIMEOUT_S:-2.5}
      - STATE_CONF_THRESHOLD=${STATE_CONF_THRESHOLD:-0.10}
      - DEBUG_STATE_EVERY=${DEBUG_STATE_EVERY:-0}
      - EMIT_BOOT_EVENT=${EMIT_BOOT_EVENT:-0}
      - DEMO_EMIT_INTERVAL_S=${DEMO_EMIT_INTERVAL_S:-0}
      - DEMO_ZONE=${DEMO_ZONE:-latch}
      - EVIDENCE_DIR=${EVIDENCE_DIR:-/tmp/safehaven_evidence}
      - SAVE_EVENT_MEDIA=${SAVE_EVENT_MEDIA:-1}
      - ZONE_CLASS_MAP=${ZONE_CLASS_MAP:-}
      - RTSP_TRANSPORT=${RTSP_TRANSPORT:-tcp}
      - CAMERAS=${CAMERAS:-}
    volumes:
      - ./safehaven-core/config:/config:ro
      - ./evidence:/tmp/safehaven_evidence
    ports:
      - "9108:9108"
      - "9109:9109"
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:9109/healthz', timeout=2)"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 20s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

volumes:
  frigate-media:
